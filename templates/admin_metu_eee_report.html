<!DOCTYPE html>
<html class="dark" lang="tr">

<head>
    <meta charset="utf-8" />
    <title>ODTÃœ EEE Scopus Raporu - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: "#1132d4", background: "#101322" }, fontFamily: { display: ["Space Grotesk", "sans-serif"] } } } };
    </script>
</head>

<body class="bg-background font-display text-white min-h-screen">
    <nav
        class="border-b border-white/10 px-8 py-4 flex justify-between items-center bg-black/20 backdrop-blur-md sticky top-0 z-50">
        <div class="text-xl font-bold flex items-center gap-2">
            <span class="text-orange-400">ğŸ“Š</span> ODTÃœ EEE Scopus Raporu
        </div>
        <div class="flex items-center gap-4">
            <a href="{{ url_for('admin_dashboard') }}" class="text-sm text-gray-400 hover:text-white">â† Admin Panel</a>
            <a href="{{ url_for('logout') }}"
                class="text-sm text-red-400 hover:text-red-300 border border-red-500/30 px-3 py-1.5 rounded-lg">
                Ã‡Ä±kÄ±ÅŸ Yap
            </a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold flex items-center gap-3">
                <span class="text-orange-400">ğŸ“</span>
                ODTÃœ Elektrik-Elektronik MÃ¼hendisliÄŸi Scopus Raporu
            </h1>
            <p class="text-gray-400 text-sm mt-2">2025 yÄ±lÄ± makale ve bildiri yayÄ±nlarÄ±</p>
        </div>

        <!-- Report Form -->
        <div class="bg-white/5 border border-white/10 rounded-2xl p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Rapor AyarlarÄ±</h2>

            <form id="reportForm" class="space-y-4">
                <!-- Year Selection -->
                <div>
                    <label class="text-sm text-gray-400 block mb-2">YayÄ±n YÄ±lÄ±</label>
                    <input type="number" name="year" value="2025" min="2000" max="2030"
                        class="w-full md:w-48 bg-black/40 border border-white/10 rounded-lg p-3 text-sm text-white focus:border-orange-500 outline-none">
                </div>

                <!-- Mode Selection -->
                <div>
                    <label class="text-sm text-gray-400 block mb-2">Hoca Listesi Modu</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="mode" value="auto" checked
                                class="text-orange-500 focus:ring-orange-500" onchange="toggleManualInput()">
                            <span class="text-sm">Otomatik (Scopus API'den Ã§ek)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="mode" value="manual" class="text-orange-500 focus:ring-orange-500"
                                onchange="toggleManualInput()">
                            <span class="text-sm">Manuel (Ä°sim listesi gir)</span>
                        </label>
                    </div>
                </div>

                <!-- Manual Input (Hidden by default) -->
                <div id="manualInputDiv" class="hidden">
                    <label class="text-sm text-gray-400 block mb-2">Hoca Ä°simleri (Her satÄ±ra bir isim)</label>
                    <textarea name="faculty_list" rows="8" placeholder="Ã–rn:&#10;Nevzat GÃ¼neri GenÃ§er&#10;Ã–zgÃ¼r GÃ¼rbÃ¼z"
                        class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-sm text-white focus:border-orange-500 outline-none resize-none"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Her satÄ±ra bir Ã¶ÄŸretim Ã¼yesi ismi yazÄ±n.</p>
                </div>

                <button type="submit"
                    class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-3 rounded-lg font-bold transition shadow-lg flex items-center gap-2">
                    <span>ğŸš€</span> Rapor OluÅŸtur
                </button>
            </form>
        </div>

        <!-- Progress Bar (Hidden initially) -->
        <div id="progressSection"
            class="hidden bg-gradient-to-r from-orange-900/20 to-black border border-orange-500/30 rounded-2xl p-6 mb-8">
            <div class="flex items-center gap-3 mb-4">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-orange-400 border-t-transparent"></div>
                <span class="text-lg font-bold text-orange-400">Veriler Scopus API'den Ã§ekiliyor...</span>
            </div>
            <div class="w-full bg-black/40 rounded-full h-3 overflow-hidden">
                <div id="progressBar"
                    class="bg-gradient-to-r from-orange-500 to-orange-400 h-full transition-all duration-500"
                    style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-400 mt-2">BaÅŸlatÄ±lÄ±yor...</p>
        </div>

        <!-- Results Section (Hidden initially) -->
        <div id="resultsSection" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                <div class="bg-gradient-to-br from-blue-900/20 to-black border border-blue-500/30 rounded-2xl p-6">
                    <p class="text-sm text-blue-400 mb-1">Toplam Ã–ÄŸretim Ãœyesi</p>
                    <p id="totalFaculty" class="text-4xl font-bold text-white">0</p>
                </div>
                <div class="bg-gradient-to-br from-green-900/20 to-black border border-green-500/30 rounded-2xl p-4">
                    <p class="text-xs text-green-400 mb-1">Makale (UluslararasÄ±)</p>
                    <p id="totalArticlesInt" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="bg-gradient-to-br from-green-700/20 to-black border border-green-400/30 rounded-2xl p-4">
                    <p class="text-xs text-green-300 mb-1">Makale (Ulusal)</p>
                    <p id="totalArticlesNat" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="bg-gradient-to-br from-purple-900/20 to-black border border-purple-500/30 rounded-2xl p-4">
                    <p class="text-xs text-purple-400 mb-1">Bildiri (UluslararasÄ±)</p>
                    <p id="totalConferencesInt" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="bg-gradient-to-br from-purple-700/20 to-black border border-purple-400/30 rounded-2xl p-4">
                    <p class="text-xs text-purple-300 mb-1">Bildiri (Ulusal)</p>
                    <p id="totalConferencesNat" class="text-3xl font-bold text-white">0</p>
                </div>
            </div>

            <!-- Export Button -->
            <div class="mb-6 flex justify-end">
                <button onclick="exportToCSV()"
                    class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                    <span>ğŸ“¥</span> CSV'ye Aktar
                </button>
            </div>

            <!-- Faculty Table -->
            <div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-black/40">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-300">Ã–ÄŸretim Ãœyesi</th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-green-400">
                                    Makale<br />(UluslararasÄ±)</th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-green-300">Makale<br />(Ulusal)
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-purple-400">
                                    Bildiri<br />(UluslararasÄ±)</th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-purple-300">
                                    Bildiri<br />(Ulusal)</th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-gray-300">Toplam</th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-gray-300">Detay</th>
                            </tr>
                        </thead>
                        <tbody id="facultyTableBody" class="divide-y divide-white/10">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="hidden bg-red-900/20 border border-red-500/30 rounded-2xl p-6">
            <h3 class="text-lg font-bold text-red-400 mb-2">âŒ Hata OluÅŸtu</h3>
            <p id="errorMessage" class="text-sm text-gray-300"></p>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detailModal"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
        onclick="closeModal(event)">
        <div class="bg-background border border-white/10 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="bg-black/40 px-6 py-4 border-b border-white/10 flex items-center justify-between sticky top-0">
                <h3 id="modalTitle" class="text-xl font-bold text-white"></h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        let reportData = null;

        function toggleManualInput() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const manualDiv = document.getElementById('manualInputDiv');
            manualDiv.classList.toggle('hidden', mode === 'auto');
        }

        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);

            // Show progress, hide results and errors
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');

            // Disable form
            e.target.querySelectorAll('input, button, textarea').forEach(el => el.disabled = true);

            try {
                // Simulate progress (since we can't track real progress server-side easily)
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress > 90) progress = 90;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = `Ä°ÅŸleniyor... ${progress}%`;
                }, 500);

                const response = await fetch('{{ url_for("admin_metu_eee_data") }}', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);

                if (!response.ok) {
                    throw new Error('Sunucu hatasÄ±: ' + response.status);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                reportData = data;

                // Complete progress
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressText').textContent = 'TamamlandÄ±! âœ…';

                setTimeout(() => {
                    document.getElementById('progressSection').classList.add('hidden');
                    displayResults(data);
                }, 1000);

            } catch (error) {
                document.getElementById('progressSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            } finally {
                // Re-enable form
                e.target.querySelectorAll('input, button, textarea').forEach(el => el.disabled = false);
            }
        });

        function displayResults(data) {
            // Update summary cards
            document.getElementById('totalFaculty').textContent = data.faculty_data.length;
            document.getElementById('totalArticlesInt').textContent = data.total_articles_international;
            document.getElementById('totalArticlesNat').textContent = data.total_articles_national;
            document.getElementById('totalConferencesInt').textContent = data.total_conferences_international;
            document.getElementById('totalConferencesNat').textContent = data.total_conferences_national;

            // Populate table
            const tbody = document.getElementById('facultyTableBody');
            tbody.innerHTML = '';

            data.faculty_data.forEach((faculty, index) => {
                const total = faculty.total_articles_international + faculty.total_articles_national +
                    faculty.total_conferences_international + faculty.total_conferences_national;
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/5 transition';
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-bold text-white text-sm">${faculty.name}</div>
                        ${faculty.author_id ? `<div class="text-xs text-gray-500">ID: ${faculty.author_id}</div>` : '<div class="text-xs text-red-400">ID bulunamadÄ±</div>'}
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block bg-green-900/30 text-green-400 px-2 py-1 rounded-full text-sm font-bold">${faculty.total_articles_international}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block bg-green-700/30 text-green-300 px-2 py-1 rounded-full text-sm font-bold">${faculty.total_articles_national}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block bg-purple-900/30 text-purple-400 px-2 py-1 rounded-full text-sm font-bold">${faculty.total_conferences_international}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block bg-purple-700/30 text-purple-300 px-2 py-1 rounded-full text-sm font-bold">${faculty.total_conferences_national}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="text-lg font-bold text-white">${total}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        ${total > 0 ? `<button onclick="showDetail(${index})" class="bg-orange-600 hover:bg-orange-500 text-white px-3 py-1 rounded text-sm font-bold transition">Detay</button>` : '<span class="text-gray-500 text-sm">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function showDetail(index) {
            const faculty = reportData.faculty_data[index];
            document.getElementById('modalTitle').textContent = faculty.name + ' - YayÄ±n DetaylarÄ±';

            let content = '';

            // International Articles
            if (faculty.articles_international.length > 0) {
                content += `<div class="mb-6">
                    <h4 class="text-lg font-bold text-green-400 mb-3 flex items-center gap-2">
                        <span>ğŸ“„</span> Makaleler - UluslararasÄ± (${faculty.articles_international.length})
                    </h4>
                    <div class="space-y-3">`;

                faculty.articles_international.forEach((pub, idx) => {
                    content += `<div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <p class="font-bold text-white text-sm mb-1">${idx + 1}. ${pub.title}</p>
                        <p class="text-xs text-gray-400">${pub.venue}</p>
                        ${pub.publisher ? `<p class="text-xs text-gray-500">YayÄ±ncÄ±: ${pub.publisher}</p>` : ''}
                        <p class="text-xs text-gray-500">Tarih: ${pub.date}</p>
                    </div>`;
                });

                content += `</div></div>`;
            }

            // National Articles
            if (faculty.articles_national.length > 0) {
                content += `<div class="mb-6">
                    <h4 class="text-lg font-bold text-green-300 mb-3 flex items-center gap-2">
                        <span>ğŸ“„</span> Makaleler - Ulusal (${faculty.articles_national.length})
                    </h4>
                    <div class="space-y-3">`;

                faculty.articles_national.forEach((pub, idx) => {
                    content += `<div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <p class="font-bold text-white text-sm mb-1">${idx + 1}. ${pub.title}</p>
                        <p class="text-xs text-gray-400">${pub.venue}</p>
                        ${pub.publisher ? `<p class="text-xs text-gray-500">YayÄ±ncÄ±: ${pub.publisher}</p>` : ''}
                        <p class="text-xs text-gray-500">Tarih: ${pub.date}</p>
                    </div>`;
                });

                content += `</div></div>`;
            }

            // International Conferences
            if (faculty.conferences_international.length > 0) {
                content += `<div class="mb-6">
                    <h4 class="text-lg font-bold text-purple-400 mb-3 flex items-center gap-2">
                        <span>ğŸ“¢</span> Bildiriler - UluslararasÄ± (${faculty.conferences_international.length})
                    </h4>
                    <div class="space-y-3">`;

                faculty.conferences_international.forEach((pub, idx) => {
                    content += `<div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <p class="font-bold text-white text-sm mb-1">${idx + 1}. ${pub.title}</p>
                        <p class="text-xs text-gray-400">${pub.venue}</p>
                        ${pub.publisher ? `<p class="text-xs text-gray-500">YayÄ±ncÄ±: ${pub.publisher}</p>` : ''}
                        <p class="text-xs text-gray-500">Tarih: ${pub.date}</p>
                    </div>`;
                });

                content += `</div></div>`;
            }

            // National Conferences
            if (faculty.conferences_national.length > 0) {
                content += `<div>
                    <h4 class="text-lg font-bold text-purple-300 mb-3 flex items-center gap-2">
                        <span>ğŸ“¢</span> Bildiriler - Ulusal (${faculty.conferences_national.length})
                    </h4>
                    <div class="space-y-3">`;

                faculty.conferences_national.forEach((pub, idx) => {
                    content += `<div class="bg-white/5 border border-white/10 rounded-lg p-4">
                        <p class="font-bold text-white text-sm mb-1">${idx + 1}. ${pub.title}</p>
                        <p class="text-xs text-gray-400">${pub.venue}</p>
                        ${pub.publisher ? `<p class="text-xs text-gray-500">YayÄ±ncÄ±: ${pub.publisher}</p>` : ''}
                        <p class="text-xs text-gray-500">Tarih: ${pub.date}</p>
                    </div>`;
                });

                content += `</div></div>`;
            }

            const totalPubs = faculty.articles_international.length + faculty.articles_national.length +
                faculty.conferences_international.length + faculty.conferences_national.length;

            if (totalPubs === 0) {
                content = '<p class="text-gray-400">Bu Ã¶ÄŸretim Ã¼yesi iÃ§in belirtilen yÄ±lda yayÄ±n bulunamadÄ±.</p>';
            }

            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeModal(event) {
            if (event.target.id === 'detailModal') {
                closeDetailModal();
            }
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function exportToCSV() {
            if (!reportData) return;

            let csv = 'Ã–ÄŸretim Ãœyesi,Scopus ID,Makale (UluslararasÄ±),Makale (Ulusal),Bildiri (UluslararasÄ±),Bildiri (Ulusal),Toplam\n';

            reportData.faculty_data.forEach(faculty => {
                const total = faculty.total_articles_international + faculty.total_articles_national +
                    faculty.total_conferences_international + faculty.total_conferences_national;
                csv += `"${faculty.name}","${faculty.author_id || 'N/A'}",${faculty.total_articles_international},${faculty.total_articles_national},${faculty.total_conferences_international},${faculty.total_conferences_national},${total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ODTU_EEE_Scopus_Raporu_${reportData.year}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>

</html>