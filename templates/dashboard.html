<!DOCTYPE html>
<html class="dark" lang="tr">

<head>
    <meta charset="utf-8" />
    <title>Panel - Academic Eye</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: "#1132d4", background: "#101322" }, fontFamily: { display: ["Space Grotesk", "sans-serif"] } } } };
    </script>
</head>

<body class="bg-background font-display text-white min-h-screen">

    <nav
        class="border-b border-white/10 px-8 py-4 flex justify-between items-center bg-black/20 backdrop-blur-md sticky top-0 z-50">
        <div class="text-xl font-bold flex items-center gap-2"><span class="text-primary">â—†</span> Academic Eye</div>
        <div class="flex items-center gap-4">
            {% if is_admin %}
            <a href="{{ url_for('admin_dashboard') }}"
                class="text-sm text-yellow-400 hover:text-yellow-300 border border-yellow-500/30 px-3 py-1.5 rounded-lg flex items-center gap-1">
                <span>âš¡</span> Admin Panel
            </a>
            {% endif %}
            <span class="text-gray-400 text-sm hidden sm:block">HoÅŸgeldin, {{ user_name }}</span>
            <a href="{{ url_for('logout') }}"
                class="text-sm text-red-400 hover:text-red-300 border border-red-500/30 px-3 py-1.5 rounded-lg">Ã‡Ä±kÄ±ÅŸ
                Yap</a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="space-y-6">
            <div class="bg-white/5 border border-white/10 rounded-2xl p-6 space-y-4">
                <h2 class="text-lg font-bold">Entegrasyonlar</h2>

                {% if is_mendeley_connected %}
                <div
                    class="flex items-center justify-center gap-2 bg-red-900/30 border border-red-500/50 text-red-400 px-4 py-2 rounded-lg text-sm w-full cursor-default select-none">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Mendeley_Logo_Vertical.png"
                        class="h-4 w-4 bg-white rounded-full p-0.5">
                    Mendeley BaÄŸlÄ±
                </div>
                {% else %}
                <a href="{{ url_for('connect_mendeley') }}"
                    class="flex items-center justify-center gap-2 bg-[#980608] hover:bg-[#7a0506] text-white px-4 py-2 rounded-lg text-sm transition shadow-lg w-full">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Mendeley_Logo_Vertical.png"
                        class="h-4 w-4 bg-white rounded-full p-0.5">
                    Mendeley BaÄŸla
                </a>
                {% endif %}

                <div class="h-px bg-white/10"></div>

                <script>
                    function handleFormSubmit(event, btnText) {
                        const form = event.target;
                        const btn = form.querySelector('button[type="submit"]');
                        if (btn.disabled) return false;
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        btn.innerHTML = `<span class="animate-spin inline-block w-4 h-4 border-2 border-white/20 border-t-white rounded-full mr-2"></span> ${btnText || 'Ä°ÅŸleniyor...'}`;
                        return true;
                    }
                </script>

                {% if stats['scopus_id'] %}
                <div class="flex flex-col gap-2">
                    <div
                        class="flex items-center justify-center gap-2 bg-orange-900/30 border border-orange-500/50 text-orange-400 px-4 py-2 rounded-lg text-sm w-full cursor-default">
                        <span class="text-xs">ğŸŒ</span> Scopus BaÄŸlÄ±
                    </div>
                    <a href="https://www.scopus.com/authid/detail.uri?authorId={{ stats['scopus_id'] }}" target="_blank"
                        class="text-center text-xs text-orange-400 hover:text-orange-300 underline">Profili GÃ¶rÃ¼ntÃ¼le
                        â†—</a>
                </div>
                {% else %}
                <form action="{{ url_for('update_scopus_link') }}" method="POST" class="space-y-3"
                    onsubmit="return handleFormSubmit(event, 'BaÄŸlanÄ±yor...')">
                    <div class="bg-orange-900/20 border border-orange-500/20 p-4 rounded-xl text-center">
                        <p class="text-xs text-orange-200 mb-2">Scopus Profilinizi Otomatik Bulun</p>
                        <!-- Hidden input ekliyoruz Ã§Ã¼nkÃ¼ JS butonu disable edince value gitmiyor -->
                        <input type="hidden" name="action" value="auto">
                        <button type="submit"
                            class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded-lg text-sm transition shadow-lg flex items-center justify-center gap-2">
                            <span>ğŸŒ</span> Profilimi Bul ve BaÄŸla
                        </button>
                        <p class="text-[9px] text-gray-500 mt-2">"{{ user_name }}" ismiyle aranacaktÄ±r.</p>
                    </div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <span class="w-full border-t border-white/10"></span>
                        </div>
                        <div class="relative flex justify-center text-xs uppercase">
                            <span class="bg-[#1a1d2d] px-2 text-gray-600 text-[10px]">veya manuel gir</span>
                        </div>
                    </div>

                    <div>
                        <input type="text" name="scopus_input" placeholder="Manuel Link veya ID (Opsiyonel)"
                            class="w-full bg-black/40 border border-white/10 rounded-lg p-2 text-xs text-white focus:border-orange-500 outline-none text-center placeholder-gray-600">
                    </div>
                </form>
                {% endif %}

                <div class="h-px bg-white/10"></div>

                {% if stats['yok_id'] %}
                <div class="flex flex-col gap-2">
                    <div
                        class="flex items-center justify-center gap-2 bg-purple-900/30 border border-purple-500/50 text-purple-400 px-4 py-2 rounded-lg text-sm w-full cursor-default">
                        <span class="text-xs">ğŸ‡¹ğŸ‡·</span> YÃ–K BaÄŸlÄ± ({{ stats['yok_id'] }})
                    </div>
                    <div class="flex gap-2">
                        <a href="https://akademik.yok.gov.tr/AkademikArama/Akademisyen/Detay/{{ stats['yok_id'] }}"
                            target="_blank"
                            class="flex-1 text-center bg-white/5 hover:bg-white/10 text-xs text-purple-400 py-2 rounded border border-white/5 transition">
                            Profili GÃ¶rÃ¼ntÃ¼le â†—
                        </a>
                        <form action="{{ url_for('update_yok_id_route') }}" method="POST" class="flex-1"
                            onsubmit="return handleFormSubmit(event, 'GÃ¼ncelleniyor...')">
                            <button type="submit"
                                class="w-full bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 border border-purple-500/30 py-2 rounded text-xs font-bold transition flex items-center justify-center gap-1"
                                title="Verileri tekrar Ã§ek ve analiz et">
                                <span>ğŸ”„</span> GÃ¼ncelle
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <form action="{{ url_for('update_yok_id_route') }}" method="POST" class="space-y-4"
                    onsubmit="return handleFormSubmit(event, 'BaÄŸlanÄ±yor...')">
                    <div class="bg-purple-900/20 border border-purple-500/20 p-4 rounded-xl text-center">
                        <p class="text-xs text-purple-200 mb-3">YÃ–K Profiliniz henÃ¼z baÄŸlÄ± deÄŸil.</p>
                        <button type="submit"
                            class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg text-sm transition shadow-lg shadow-purple-900/20 flex items-center justify-center gap-2">
                            <span>ğŸš€</span> YÃ–K Verilerini Otomatik BaÄŸla
                        </button>
                        <p class="text-[10px] text-gray-400 mt-2">Ä°sminizle arama yapÄ±larak profiliniz bulunacaktÄ±r.</p>
                    </div>
                </form>
                {% endif %}
            </div>

            <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="text-primary">âš™ï¸</span> Asistan
                    & Ä°lgi AlanÄ±</h2>
                <form action="{{ url_for('update_settings') }}" method="POST" class="space-y-4">
                    <div>
                        <label class="text-xs text-primary font-bold block mb-1">AraÅŸtÄ±rma KonularÄ±nÄ±z</label>
                        <textarea name="keywords" rows="4"
                            class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-sm focus:border-primary outline-none resize-none text-gray-300">{{ keywords }}</textarea>
                    </div>
                    <div class="h-px bg-white/10 my-2"></div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">AnlatÄ±m TarzÄ±</label>
                        <select name="style"
                            class="w-full bg-black/40 border border-white/10 rounded-lg p-2 text-sm focus:border-primary outline-none">
                            <option value="samimi" {% if current_style=='samimi' %}selected{% endif %}>ğŸ™ï¸ Samimi
                                (Radyocu)</option>
                            <option value="orta" {% if current_style=='orta' %}selected{% endif %}>â˜• Orta (Normal)
                            </option>
                            <option value="resmi" {% if current_style=='resmi' %}selected{% endif %}>ğŸ“ Resmi (Akademik)
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Ä°Ã§erik UzunluÄŸu</label>
                        <select name="detail_level"
                            class="w-full bg-black/40 border border-white/10 rounded-lg p-2 text-sm focus:border-primary outline-none">
                            <option value="ana_mantik" {% if current_detail=='ana_mantik' %}selected{% endif %}>ğŸ’¡ Orta
                                (Dengeli)</option>
                            <option value="kisa" {% if current_detail=='kisa' %}selected{% endif %}>âš¡ Ã‡ok KÄ±sa (Ã–zet)
                            </option>
                            <option value="detayli" {% if current_detail=='detayli' %}selected{% endif %}>ğŸ”¬ DetaylÄ±
                                (Deep Dive)</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="w-full bg-primary/20 hover:bg-primary/40 text-primary border border-primary/50 font-bold py-2 rounded-lg text-sm transition mt-2">TÃ¼m
                        AyarlarÄ± GÃ¼ncelle</button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="grid grid-cols-1 gap-4 mb-6">
                <!-- Citation ve H-Index KaldÄ±rÄ±ldÄ± -->

                <div
                    class="bg-white/5 border border-white/10 p-4 rounded-2xl flex flex-col items-center justify-center text-center">
                    <span class="text-xs text-gray-400">Veri KaynaÄŸÄ±</span>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
                        <span class="text-sm font-bold text-gray-300">Scopus</span>
                    </div>
                    {% if stats['last_scan_date'] %}
                    <span class="text-[10px] text-gray-500 mt-1">GÃ¼ncelleme: {{ stats['last_scan_date'] }}</span>
                    {% endif %}
                </div>
            </div>

            {% if stats['analysis_report'] or (stats['scholar_id'] and stats['yok_id']) %}
            <div
                class="bg-gradient-to-r from-orange-900/20 to-black border border-orange-500/30 rounded-2xl p-6 mb-6 relative overflow-hidden">
                <div
                    class="absolute top-0 right-0 -mt-2 -mr-2 bg-orange-500 text-black text-[10px] font-bold px-2 py-1 rounded-bl-lg">
                    DENETÃ‡Ä° MODU</div>
                <h3 class="text-lg font-bold text-orange-400 flex items-center gap-2">âš ï¸ Kariyer GÃ¶rÃ¼nÃ¼rlÃ¼k Raporu</h3>

                {% if stats['analysis_report'] %}
                <!-- DetaylÄ± Analiz Raporu -->
                <div class="mt-4 space-y-4">

                    <!-- 1. YAYINLAR -->
                    <!-- GAP ANALÄ°ZÄ° (YÃ–K ve IEEE KarÅŸÄ±laÅŸtÄ±rmasÄ±) -->
                    <!-- GAP ANALÄ°ZÄ° (YÃ–K ve IEEE KarÅŸÄ±laÅŸtÄ±rmasÄ±) -->
                    {% set missing_yok_articles = stats['analysis_report'].get('missing_yok_articles', []) %}
                    {% set missing_yok_conferences = stats['analysis_report'].get('missing_yok_conferences', []) %}
                    {% set total_missing = missing_yok_articles|length + missing_yok_conferences|length %}

                    {% if total_missing > 0 %}
                    <div
                        class="bg-gradient-to-r from-red-900/20 to-orange-900/20 border border-red-500/20 rounded-xl p-6 text-center">
                        <div class="flex justify-center gap-8 mb-4">
                            <div class="text-center">
                                <span class="block text-2xl font-bold text-orange-400">{{ total_missing }}</span>
                                <span class="text-[10px] text-orange-200 uppercase tracking-widest">YÃ–K'te Eksik</span>
                            </div>
                        </div>

                        <p class="text-sm text-gray-400 mb-2">
                            Scopus profilinizde bulunan ancak YÃ–K sisteminde yer almayan yayÄ±nlar tespit edildi.
                        </p>

                        <div class="flex justify-center gap-4 text-xs text-gray-500 mb-4">
                            <span>ğŸ“„ {{ missing_yok_articles|length }} Makale</span>
                            <span>ğŸ“¢ {{ missing_yok_conferences|length }} Bildiri</span>
                        </div>

                        <a href="{{ url_for('mismatched_articles') }}"
                            class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-red-900/20">
                            <span>ğŸ“‹</span> Uyumsuzluk Raporunu Ä°ncele
                        </a>
                    </div>
                    {% else %}
                    <!-- Ä°kisi de boÅŸsa: TAM SENKRONÄ°ZASYON -->
                    <div
                        class="flex items-center gap-3 text-sm text-green-400 bg-green-900/10 p-4 rounded-lg border border-green-500/20 shadow-lg shadow-green-900/10 mb-4">
                        <span class="text-2xl">âœ…</span>
                        <div>
                            <span class="font-bold block text-green-300">Harika! Profilleriniz Tam Senkronize</span>
                            <span class="text-xs text-gray-400">YÃ–K ve Scopus yayÄ±n listeleriniz birebir
                                eÅŸleÅŸiyor.</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- 2. TEZLER -->
                    {% if stats['analysis_report']['unverified_theses'] %}
                    <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
                        <h4 class="text-sm font-bold text-yellow-300 mb-2">YayÄ±na DÃ¶nÃ¼ÅŸmemiÅŸ/Bulunamayan Tezler ({{
                            stats['analysis_report']['unverified_theses']|length }})</h4>
                        <ul class="list-disc list-inside text-xs text-gray-400 space-y-1">
                            {% for thesis in stats['analysis_report']['unverified_theses'][:3] %}
                            <li>{{ thesis[:80] }}...</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- 3. PROJELER VE Ã–DÃœLLER -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if stats['analysis_report']['unverified_projects'] %}
                        <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-3">
                            <h4 class="text-xs font-bold text-orange-300 mb-1">GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ DÃ¼ÅŸÃ¼k Projeler</h4>
                            <p class="text-[10px] text-gray-400 mb-2">Google aramalarÄ±nda bulunamadÄ±.</p>
                            <ul class="list-disc list-inside text-[10px] text-gray-500">
                                {% for proj in stats['analysis_report']['unverified_projects'][:3] %}
                                <li>{{ proj[:40] }}...</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if stats['analysis_report']['unverified_awards'] %}
                        <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-3">
                            <h4 class="text-xs font-bold text-orange-300 mb-1">DoÄŸrulanamayan Ã–dÃ¼ller</h4>
                            <ul class="list-disc list-inside text-[10px] text-gray-500">
                                {% for award in stats['analysis_report']['unverified_awards'][:3] %}
                                <li>{{ award[:40] }}...</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>

                </div>

                {% elif stats['scholar_id'] and stats['yok_id'] %}
                <!-- Basit Mod (Analiz HenÃ¼z Ã‡alÄ±ÅŸmamÄ±ÅŸ) -->
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-400">Google Scholar PayÄ±</p>
                        <p class="text-2xl font-bold text-white">{{ stats['scholar_paper_count'] }}</p>
                    </div>
                    <div>
                        <p class="text-gray-400">YÃ–K KayÄ±tlÄ± YayÄ±n</p>
                        <p class="text-2xl font-bold text-white">{{ stats['yok_paper_count'] }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <h2 class="text-2xl font-bold mb-6">ğŸ“š Size GÃ¶nderilen Makaleler</h2>
            <div class="space-y-4">
                {% for paper in papers %}
                <div class="bg-white/5 border border-white/10 rounded-xl p-6 hover:border-primary/50 transition group">
                    <h3 class="text-xl font-bold text-white group-hover:text-primary transition">{{ paper['title'] }}
                    </h3>
                    <div class="flex gap-4 text-xs text-gray-500 mt-2 mb-4">
                        <span>ğŸ“… {{ paper['date_added'] }}</span>
                        <span>ğŸ”— <a href="{{ paper['url'] }}" target="_blank" class="hover:text-white">Orjinal
                                Kaynak</a></span>
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed bg-black/20 p-4 rounded-lg whitespace-pre-line">
                        {{ paper['summary'][:400] }}...
                        <a href="{{ paper['url'] }}" target="_blank" class="text-primary ml-2 hover:underline">DevamÄ±nÄ±
                            Oku</a>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-20 text-gray-500 border border-dashed border-white/10 rounded-xl">
                    <p class="text-xl">HenÃ¼z makale bulunamadÄ±.</p>
                    <p class="text-sm">Bot Ã§alÄ±ÅŸÄ±nca burasÄ± dolacak.</p>
                </div>
                {% endfor %}
            </div>
        </div>

    </main>
</body>

</html>